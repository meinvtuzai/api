<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <title>é‡è‰åŠ©æ‰‹Byè·¯å°§</title>
    <style>
        /* è‡ªå®šä¹‰æ ·å¼ */
       .grid-item {
            min-width: clamp(120px, 15vw, 160px);
            /* ä½¿ç”¨ clamp å‡½æ•°å®ç°å“åº”å¼æœ€å°å®½åº¦ */
            min-height: clamp(120px, 15vw, 160px);
            /* ä½¿ç”¨ clamp å‡½æ•°å®ç°å“åº”å¼æœ€å°é«˜åº¦ */
            aspect-ratio: 1 / 1;
            /* ç¡®ä¿ä¸ºæ­£æ–¹å½¢ */
            width: 100%;
            /* è®©å®½åº¦è‡ªé€‚åº”çˆ¶å®¹å™¨ */
            box-sizing: border-box;
            /* ç¡®ä¿å†…è¾¹è·å’Œè¾¹æ¡†ä¸å½±å“å°ºå¯¸ */
        }

       .truncate-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        #search-container {
            scroll-margin-top: 2rem;
        }

        /* è¿›ä¸€æ­¥ä¼˜åŒ–ç„¦ç‚¹æ ·å¼ */
        button:focus,
        input:focus,
       .grid-item:focus {
            transform: scale(1.05);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.5);
            outline: none;
        }

        /* æ ‡ç­¾æ æ ·å¼è°ƒæ•´ */
        #category-buttons button {
            font-size: 1.25rem;
            /* åŠ å¤§ä¸¤å· */
            font-weight: bold;
            /* åŠ ç²— */
            padding: 0.75rem 1.5rem;
            /* åŒæ¯”ä¾‹æ”¾å¤§æŒ‰é’® */
        }

        /* ç‰ˆæœ¬å·æ ·å¼è°ƒæ•´ */
       .grid-item p.text-xs {
            line-height: 0.2;
            /* ç¼©å°è¡Œé—´è· */
            font-weight: bold;
            /* æ–‡å­—åŠ ç²— */
        }

        /* ä¸‹æ‹‰åˆ—è¡¨æ ·å¼ */
        #search-dropdown {
            position: absolute;
            top: calc(100% + 2px);
            left: 0;
            width: calc(100% - 4px);
            /* è€ƒè™‘è¾¹æ¡†ï¼Œä¿è¯ä¸æ–‡æœ¬æ¡†åŒå®½ */
            overflow-y: auto;
            background-color: #fff;
            /* ä¸æ–‡æœ¬æ¡†åŒåº•è‰² */
            border: 1px solid #ccc;
            z-index: 10;
            box-shadow: 0 4px 6 - 1px rgba(0, 0, 0, 0.1), 0 2px 4 - 1px rgba(0, 0, 0, 0.06);
        }

        #search-dropdown div {
            padding: 8px 12px;
            cursor: pointer;
        }

        #search-dropdown div:hover {
            background-color: #f0f0f0;
        }

        #search-dropdown div:focus {
            background-color: #e0e0e0;
        }
    </style>
</head>

<body class="bg-gray-100">
    <div class="container mx-auto p-4">
        <!-- æœç´¢æ  -->
        <div id="search-container" class="mb-6 grid grid-cols-1 md:grid-cols-[1fr_auto] gap-2 items-center relative">
            <input type="text" id="search-code"
                class="w-full px-4 py-3 rounded-lg border-2 border-gray-200 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 text-lg transition-all"
                placeholder="è¾“å…¥é‡è‰å£ä»¤ï¼ˆå¦‚11AAã€5DF5ã€8980ã€2004ã€DA4Fï¼ŒD381ã€AAD9ã€E9D1ã€BB1D)" tabindex="0">
            <div id="search-dropdown"></div>
            <div class="flex gap-2">
                <button id="search-btn"
                    class="whitespace-nowrap px-6 py-3 bg-blue-600 text-white rounded-lg text-lg hover:bg-blue-700 focus:ring-2 focus:ring-blue-300"
                    onclick="handleSearch()" tabindex="0">
                    ç«‹å³æœç´¢
                </button>
                <button id="clear-btn"
                    class="whitespace-nowrap px-6 py-3 bg-gray-500 text-white rounded-lg text-lg hover:bg-gray-600 focus:ring-2 focus:ring-gray-300"
                    onclick="clearSearch()" tabindex="0">
                    å¤ä½
                </button>
            </div>
        </div>

        <!-- åˆ†ç±»æ ‡ç­¾ -->
        <div class="flex flex-wrap gap-2 mb-4" id="category-buttons"></div>

        <!-- è½¯ä»¶å®«æ ¼ -->
        <div id="software-container" class="overflow-visible h-[70vh]">
            <div id="software-grid" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-3"></div>
        </div>
    </div>

    <script>
        let softwareData = [];
        let currentCategory = 'all';
        let currentCode = '';
        let focusableElements = [];
        let currentFocusIndex = 0;
        const menuData = [
            { "code": "11AA", "name": "ğŸ„ï¸å£ä»¤1â”ƒ11AA" },
            { "code": "5DF5", "name": "ğŸ„ï¸å£ä»¤2â”ƒ5DF5" },
            { "code": "8980", "name": "ğŸ„ï¸å£ä»¤3â”ƒ8980" },
            { "code": "2004", "name": "ğŸ„ï¸å£ä»¤4â”ƒ2004" },
            { "code": "DA4F", "name": "ğŸ„ï¸å£ä»¤5â”ƒDA4F" },
            { "code": "D381", "name": "ğŸ„ï¸å£ä»¤6â”ƒD381" },
            { "code": "AAD9", "name": "ğŸ„ï¸å£ä»¤7â”ƒAAD9" },
            { "code": "E9D1", "name": "ğŸ„ï¸å£ä»¤8â”ƒE9D1" },
            { "code": "BB1D", "name": "ğŸ„ï¸å£ä»¤9â”ƒBB1D" }
        ];
        let dropdownIndex = -1;

        // åˆå§‹åŒ–
        window.addEventListener('DOMContentLoaded', () => {
            fetchData(currentCode);
            initKeyboardNav();
            initSearchDropdown();
            setTimeout(() => {
                focusOnAllCategory();
            }, 50);
        });

        // æ•°æ®åŠ è½½
        async function fetchData(code) {
            try {
                const url = `https://hfr1107.top/api/box/yc.php?code=${code || '11aa'}`;
                console.log('Fetching data from:', url);
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();

                softwareData = data.groupApkList || [];
                initCategories(data.tagNameList || []);
                currentCategory = 'all';
                renderSoftware();

                setTimeout(() => {
                    if (softwareData.length === 0) {
                        focusOnAllCategory();
                    } else {
                        const firstGridItem = document.querySelector('.grid-item');
                        if (firstGridItem) {
                            firstGridItem.focus();
                            firstGridItem.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                        }
                    }
                }, 50);
            } catch (error) {
                console.error('Fetch error:', error);
                showError(error.message);
                focusOnAllCategory();
            }
        }

        // åˆ†ç±»æ ‡ç­¾åˆå§‹åŒ–
        function initCategories(tags) {
            const container = document.getElementById('category-buttons');
            container.innerHTML = `
                <button class="px-4 py-2 rounded-lg bg-blue-100 text-blue-800 border-2 border-blue-300 focus:ring-2 focus:ring-blue-300"
                        onclick="filterCategory('all', this)"
                        data-active="true"
                        tabindex="0">
                    å…¨éƒ¨
                </button>
            `;

            tags.forEach(tag => {
                const btn = document.createElement('button');
                btn.className = 'px-4 py-2 rounded-lg bg-gray-100 border-2 border-gray-200 hover:bg-gray-50 focus:ring-2 focus:ring-gray-300';
                btn.textContent = tag;
                btn.tabIndex = 0;
                btn.onclick = (e) => filterCategory(tag, e.currentTarget);
                container.appendChild(btn);
            });
        }

        // åˆ†ç±»ç­›é€‰
        function filterCategory(category, button) {
            currentCategory = category;
            document.querySelectorAll('#category-buttons button').forEach(btn => {
                btn.dataset.active = (btn === button).toString();
                btn.className = btn === button
                   ? 'px-4 py-2 rounded-lg bg-blue-100 text-blue-800 border-2 border-blue-300 focus:ring-2 focus:ring-blue-300'
                    : 'px-4 py-2 rounded-lg bg-gray-100 border-2 border-gray-200 hover:bg-gray-50 focus:ring-2 focus:ring-gray-300';
            });
            renderSoftware();
            button.focus();
        }

        // æ¸²æŸ“å®«æ ¼
        function renderSoftware() {
            const grid = document.getElementById('software-grid');
            grid.innerHTML = '';

            softwareData.filter(item =>
                currentCategory === 'all' ||
                item.tagList.some(tag => tag.tagName === currentCategory)
            ).forEach(item => {
                const card = document.createElement('div');
                card.className = 'grid-item bg-white p-3 rounded-xl shadow-sm hover:shadow-md transition-all focus:outline-none focus:ring-2 focus:ring-blue-500';
                card.tabIndex = 0;
                const packageName = item.meta.packageName || 'åŒ…åä¸è¯¦';
                const packageVersion = item.meta?.versionName ? `V${item.meta.versionName}` : 'ç‰ˆæœ¬ä¸è¯¦';
                const packageSize = item.apkLength ? `[${(item.apkLength / 1024).toFixed(1)}M]` : 'å¤§å°ä¸è¯¦';
                const createTime = item.tagList.length > 0 ? `[${item.tagList[0].createTime.split(' ')[0]}]` : '';
                card.onclick = () => window.open(item.pluginUrl, '_blank');
                card.innerHTML = `
    <div class="h-full flex flex-col">
        <img src="${item.meta.iconUrl}" 
             class="w-20 h-20 mx-auto mb-2 object-contain">
        <div class="flex-1">
            <h3 class="font-semibold text-center truncate-2">${item.meta.label}</h3>
            <p class="text-xs text-gray-400 text-center mt-2">${packageVersion}</p>
            <p class="text-xs text-gray-400 text-center mt-2">${packageName}</p>
            <p class="text-xs text-gray-400 text-center mt-2">${createTime}${packageSize}</p>
        </div>
                    </div>
                `;
                grid.appendChild(card);
            });

            updateFocusables();
        }

        // é”®ç›˜å¯¼èˆª
        function initKeyboardNav() {
            document.addEventListener('keydown', (e) => {
                const active = document.activeElement;
                const isSearchInput = active.id === 'search-code';
                const isSearchBtn = active.id === 'search-btn';
                const isClearBtn = active.id === 'clear-btn';
                const isCategoryBtn = active.parentElement?.id === 'category-buttons';
                const isGridItem = active.classList.contains('grid-item');
                const isDropdownOption = active.classList.contains('dropdown-option');

                // é˜»æ­¢é»˜è®¤æ»šåŠ¨è¡Œä¸º
                if (['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight', 'Escape'].includes(e.key)) {
                    e.preventDefault();
                }

                // å¤„ç†ä¸åŒå…ƒç´ çš„å¯¼èˆªé€»è¾‘
                if (isSearchInput) handleSearchNav(e);
                else if (isSearchBtn) handleSearchBtnNav(e);
                else if (isClearBtn) handleClearBtnNav(e);
                else if (isCategoryBtn) handleCategoryNav(e, active);
                else if (isGridItem) handleGridNav(e, active);
                else if (isDropdownOption) handleDropdownNav(e, active);

                if (e.key === 'Escape') {
                    focusOnAllCategory();
                }
            });
        }

        function handleSearchNav(e) {
            const dropdown = document.getElementById('search-dropdown');
            switch (e.key) {
                case 'ArrowDown':
                    if (dropdown.style.display === 'none') {
                        showSearchDropdown();
                    } else {
                        const options = dropdown.querySelectorAll('.dropdown-option');
                        if (options.length > 0) {
                            dropdownIndex = 0;
                            options[dropdownIndex].focus();
                        }
                    }
                    break;
                case 'ArrowRight':
                    document.getElementById('search-btn').focus();
                    break;
            }
        }

        function handleSearchBtnNav(e) {
            switch (e.key) {
                case 'ArrowUp':
                    document.getElementById('search-code').focus();
                    break;
                case 'ArrowLeft':
                    document.getElementById('search-code').focus();
                    break;
                case 'ArrowRight':
                    document.getElementById('clear-btn').focus();
                    break;
                case 'ArrowDown':
                    focusOnAllCategory();
                    break;
            }
        }

        function handleClearBtnNav(e) {
            switch (e.key) {
                case 'ArrowUp':
                    document.getElementById('search-code').focus();
                    break;
                case 'ArrowLeft':
                    document.getElementById('search-btn').focus();
                    break;
                case 'ArrowDown':
                    focusOnAllCategory();
                    break;
            }
        }

        function handleCategoryNav(e, active) {
            const buttons = Array.from(document.querySelectorAll('#category-buttons button'));
            const index = buttons.indexOf(active);

            switch (e.key) {
                case 'ArrowUp':
                    document.getElementById('clear-btn').focus();
                    break;
                case 'ArrowLeft':
                    if (index > 0) buttons[index - 1].focus();
                    else buttons[buttons.length - 1].focus();
                    break;
                case 'ArrowRight':
                    if (index < buttons.length - 1) buttons[index + 1].focus();
                    else buttons[0].focus();
                    break;
                case 'ArrowDown':
                    const firstGridItem = document.querySelector('.grid-item');
                    if (firstGridItem) firstGridItem.focus();
                    break;
            }
        }

        function handleGridNav(e, active) {
            const items = Array.from(document.querySelectorAll('.grid-item'));
            const index = items.indexOf(active);
            const cols = getComputedGridColumns();

            switch (e.key) {
                case 'ArrowUp':
                    if (index < cols) focusOnAllCategory();
                    else items[index - cols].focus();
                    break;
                case 'ArrowDown':
                    if (index + cols < items.length) items[index + cols].focus();
                    else items[index % cols].focus();
                    break;
                case 'ArrowLeft':
                    if (index % cols === 0) items[index + cols - 1].focus();
                    else items[index - 1].focus();
                    break;
                case 'ArrowRight':
                    if ((index + 1) % cols === 0) items[index - cols + 1].focus();
                    else items[index + 1].focus();
                    break;
            }
        }

        function handleDropdownNav(e, active) {
            const options = document.querySelectorAll('.dropdown-option');
            switch (e.key) {
                case 'ArrowUp':
                    if (dropdownIndex > 0) {
                        dropdownIndex--;
                        options[dropdownIndex].focus();
                    }
                    break;
                case 'ArrowDown':
                    if (dropdownIndex < options.length - 1) {
                        dropdownIndex++;
                        options[dropdownIndex].focus();
                    }
                    break;
                case 'Enter':
                    selectDropdownOption(active);
                    break;
            }
        }

        // è¾…åŠ©å‡½æ•°
        function getComputedGridColumns() {
            const grid = document.getElementById('software-grid');
            return parseInt(getComputedStyle(grid).gridTemplateColumns.split(' ').length);
        }

        function focusOnAllCategory() {
            const allButton = document.querySelector('#category-buttons button[data-active="true"]');
            if (allButton) {
                allButton.focus();
                allButton.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }
        }

        function updateFocusables() {
            focusableElements = Array.from(document.querySelectorAll('button, input, .grid-item, .dropdown-option'));
        }

        // æœç´¢åŠŸèƒ½
        function handleSearch() {
            const code = document.getElementById('search-code').value.replace(/[^a-zA-Z0-9]/g, '');
            if (code && code !== currentCode) {
                currentCode = code;
                fetchData(currentCode);
            }
            document.getElementById('search-code').value = '';
            hideSearchDropdown();
        }

        function clearSearch() {
            document.getElementById('search-code').value = '';
            currentCode = '';
            fetchData(currentCode);
            hideSearchDropdown();
        }

        function showError(msg) {
            document.getElementById('software-grid').innerHTML = `
                <div class="col-span-full text-center py-8 text-red-500">
                    âš ï¸ ${msg}
                </div>
            `;
        }

        // æœç´¢ä¸‹æ‹‰åˆ—è¡¨åŠŸèƒ½
        function initSearchDropdown() {
            const input = document.getElementById('search-code');
            input.addEventListener('focus', showSearchDropdown);
            input.addEventListener('blur', function (e) {
                // å»¶è¿Ÿéšè—ï¼Œé¿å…ç‚¹å‡»é€‰é¡¹æ—¶ç›´æ¥éšè—
                setTimeout(() => {
                    if (!document.getElementById('search-dropdown').contains(e.relatedTarget)) {
                        hideSearchDropdown();
                    }
                }, 100);
            });
        }

        function showSearchDropdown() {
            const dropdown = document.getElementById('search-dropdown');
            dropdown.innerHTML = '';
            menuData.forEach(option => {
                const div = document.createElement('div');
                div.textContent = option.name;
                div.className = 'dropdown-option';
                div.tabIndex = 0;
                div.dataset.code = option.code;
                div.onclick = (e) => selectDropdownOption(e.target);
                div.onkeydown = (e) => {
                    if (e.key === 'Enter') {
                        selectDropdownOption(e.target);
                    }
                };
                dropdown.appendChild(div);
            });

            // æ ¹æ® code ä¸ªæ•°åŠ¨æ€è®¾ç½® max-height
            const itemHeight = 40; // æ¯ä¸ªé€‰é¡¹çš„å¤§è‡´é«˜åº¦ï¼Œå·²è°ƒæ•´ä¸º 40px
            const maxHeight = menuData.length * itemHeight;
            dropdown.style.maxHeight = `${maxHeight}px`;

            dropdown.style.display = 'block';
        }

        function hideSearchDropdown() {
            const dropdown = document.getElementById('search-dropdown');
            dropdown.style.display = 'none';
            dropdownIndex = -1;
        }

        function selectDropdownOption(div) {
            const input = document.getElementById('search-code');
            const code = div.dataset.code;
            input.value = code;
            currentCode = code;
            fetchData(currentCode);
            hideSearchDropdown();
            input.value = '';
        }
    </script>
</body>

</html>    
